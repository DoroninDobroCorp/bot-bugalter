# Изменения от 30.09.2025

## 1. Исправлено удаление отчетов

### Проблема
Отчеты удалялись некорректно - флаг `is_deleted` устанавливался, но записи в `report_employee` оставались, что приводило к дублям и некорректным расчетам.

### Решение
- Добавлено поле `deleted_at` в таблицу `report` для отслеживания даты удаления
- При удалении теперь устанавливается флаг `is_deleted=True` и фиксируется `deleted_at`
- Создан скрипт `manager-bot/cleanup_deleted_reports.py` для автоматической очистки удаленных отчетов старше 90 дней
- Скрипт физически удаляет записи из таблиц `report` и `report_employee`

### Файлы изменены
- `manager-bot/data/models.py` - добавлена колонка `deleted_at`
- `flask_app/data/models.py` - добавлена колонка `deleted_at`
- `auto-reports-bot/modules/models.py` - добавлена колонка `deleted_at`
- `manager-bot/data/utils.py` - обновлена функция `delete_report_by_id()`
- `flask_app/app.py` - обновлен маршрут `/report/<id>/delete`
- `auto-reports-bot/modules/utils.py` - обновлена функция `delete_report()`

### Новые файлы
- `manager-bot/cleanup_deleted_reports.py` - скрипт очистки старых удаленных отчетов
- `manager-bot/add_deleted_at_migration.py` - миграция для добавления поля `deleted_at`

### Запуск миграции
```bash
cd /root/bot-bugalter/manager-bot
python3 add_deleted_at_migration.py
```

### Настройка автоочистки (cron)
Добавить в crontab для запуска раз в неделю:
```bash
0 3 * * 0 cd /root/bot-bugalter/manager-bot && python3 cleanup_deleted_reports.py >> /var/log/cleanup_reports.log 2>&1
```

---

## 2. Исправлено копирование на странице отчетов

### Проблема
На странице `/reports` нельзя было копировать текст внутри карточек отчетов.

### Решение
- Изменена структура карточек: вместо `<a>` контейнер теперь `<div>` с вложенным `<a>`
- Добавлены inline-стили `user-select: text` для всех текстовых элементов
- Изменены классы для корректного переноса длинных текстов (`break-words`)

### Файлы изменены
- `flask_app/templates/reports.html`

---

## 3. Добавлен код матча на странице отчетов

### Описание
Под названием каждого матча теперь отображается его код (ID) для удобства поиска.

### Реализация
- Код отображается серым моноширинным шрифтом
- Поддерживает копирование
- Находится между названием матча и букмекером

### Файлы изменены
- `flask_app/templates/reports.html`

---

## 4. Добавлен фильтр и сортировка по источнику в деталях матча

### Описание
На странице деталей матча (`/match/<id>`) добавлены:
- **Выпадающий фильтр** по источнику (показывает только отчеты выбранного источника)
- **Чекбокс сортировки** (группирует отчеты по источникам)
- Оба контрола можно использовать одновременно
- Работают на клиенте без перезагрузки страницы (Alpine.js)

### Особенности
- Фильтры компактные и не загромождают интерфейс
- Легко отключаются (снять галочку / выбрать "Все")
- Адаптивный дизайн для мобильных устройств

### Файлы изменены
- `flask_app/templates/match_detail.html`

---

## Совместимость
Все изменения обратно совместимы. Существующие данные не затрагиваются, необходима только миграция для добавления поля `deleted_at`.
